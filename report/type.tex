\section{Type check}

\subsection{$Check_{Exp}$}

\begin{verbatim}
checkExp(Exp, vtable, avoid) = case Exp of
    num => ok
  | id  => v := lookup(vtable, name(id))
           if type(v) is not integer
             then error (Array variable used as integer)
             else
           if name(v) = avoid
             then error (LHS variable used on RHS)
             else ok
  | id `[` Exp1 `]` =>
           checkExp(Exp1, vtable, ftable, avoid)
           v := lookup(vtable, name(id))
           if type(v) is not array
             then error (Integer variable used as array)
             else
           if name(v) = avoid
             then error (LHS variable used on RHS)
             else ok
  | Exp1 `+` Exp2
  | Exp1 `-` Exp2 =>
           checkExp(Exp1, vtable, avoid)
           checkExp(Exp2, vtable, avoid)
  | Exp1 `/2` =>
           checkExp(Exp1, vtable, avoid)
\end{verbatim}

\subsection{$Check_{Stat}$}

\begin{verbatim}
checkStat(Stat, vtable, pnames) = case Stat of
    Stat1 `;` Stat2 =>
           checkStat (Stat1, vtable, pnames)
           checkStat (stat2, vtable, pnames)
  | id `+=` Exp2
  | id `-=` Exp2 =>
           v := lookup(vtable, name(id))
           if type(v) is not integer
             then error (Array variable used as integer)
             else checkExp(Exp2, vtable, name(id))
  | id `[` Exp1 `]` `+=` Exp2
  | id `[` Exp1 `]` `-=` Exp2 =>
           checkExp(Exp1, vtable, none)
           v := lookup(vtable, name(id))
           if type(v) is not integer
             then error (Integer variable used as an array)
             else checkExp(Exp2, vtable, name(id))
  | `if` Cond1 `then` Stat1 `else` Stat2 `fi` Cond2 =>
           checkCond(Cond1, vtable)
           checkStat(Stat1, vtable, pnames)
           checkCond(Cond2, vtable)
           checkStat(Stat2, vtable, pnames)
  | `from` Cond1 `do` Stat1 `loop` Stat2 `until` Cond2 =>
           checkCond(Cond1, vtable)
           checkStat(Stat1, vtable, pnames)
           checkCond(Cond2, vtable)
           checkStat(Stat2, vtable, pnames)
  | Skip => ok
  | Call pname
  | Uncall pname =>
           v := lookup(pnames, pname)
           if v is unbound
             then error (Unknown procedure: pname)
             else ok
\end{verbatim}

\subsection{$Check_{Cond}$}

\begin{verbatim}
checkCond(Cond, vtable) = case Cond of
    Exp1 `==` Exp2
  | Exp1 `<`  Exp2 =>
           checkExp(Exp1, vtable, none)
           checkExp(Exp2, vtable, none)
  | `!` Cond1 => checkCond(Cond1, vtable)
  | Cond1 `&&` Cond2
  | Cond1 `||` Cond2 =>
           checkCond(Cond1, vtable)
           checkCond(Cond2, vtable)
\end{verbatim}

\subsection{$Check_{Defs}$}

\begin{verbatim}
checkDefs(Defs, vtable) =
           for each Def in Defs
             v := lookup(name(Def), vtable)
             if v is bound
               then error (Multiple declarations of: name(v))
               else
             if type(v) is array and size = 0
               then error (Zero-sized array: name(v))
               else ok
\end{verbatim}

